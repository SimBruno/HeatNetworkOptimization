```{python loadingdata, echo = T, eval = T}
#Load csv files (dfevap, dfhx, dfrecap)
import pandas as pd
import numpy as np
#Load csv files
dfevap = pd.read_csv('dfevap.csv', sep = ',')
dfhx = pd.read_csv('dfhx.csv', sep = ',')
dfrecap = pd.read_csv('dfrecap.csv', sep = ',')
```

```{python evap, echo = T, eval = T}
```
# Energy and exergy analysis

Upon completing the process description and analysis for each section, you will gain insights into the current operational status and energy/exergy efficiency of the dairy factory. This analysis comprises two main components:

- Exergy analysis of both pasteurisation and evaporation section
- Energy bills of the whole dairy factory under different scenarios


## Exergy analysis

In the exergy analysis, it's essential to outline the exergy inputs, exergy outputs, and exergy destruction specifically for the Pasteurization and Evaporation sections. To achieve this, you should provide both the theoretical background of exergy calculation and the step-by-step process of your analysis.

To evaluate the losses and inefficiencies of the dairy production an exergy analysis is carried out. The ambient temperature is assumed to be $T_a = 25Â°C + 273K = 293K$. 

### Pasteurization

#### Refrigeration

$$
L_{milk-refr} = \dot{m}_{in,m}c_{p,whm}[(T_{in} - T_{mix,o})-T_0\ln(\frac{T_1}{T_2})] \\
L_{gw-refr}  = \dot{m}_{gw,refr}c_{p,gw}[(T_{in,gw} - T_{out,gw})-T_0\ln(\frac{T_{in,gw}}{T_{out,gw}})] \\
L_{refr} = L_{milk-refr} + L_{gw-refr}
$$

#### Past 1, Past 2, Past 5

$$
L_{past1,1}  = \dot{m}_{in,m}c_{p,whm}[(T_{mix,o} - T_{past,cent})-T_0\ln(\frac{T_{mix,o}}{T_{past,cent}})] \\
L_{past1,2}  = \dot{m}_{out,m}c_{p,rm}[(T_{past,c} - T_{past,d})-T_0\ln(\frac{T_{past,c}}{T_{past,d}})] \\
L_{past1} = L_{past1,1} + L_{past1,2}
$$

#### Past 3, Past 6

$$
L_{past3,1}  = \dot{m}_{out,m}c_{p,rm}[(T_{past,a} - T_{past,b})-T_0\ln(\frac{T_{past,a}}{T_{past,b}})] \\
L_{past3,2}  = \dot{m}_{steam,3}[(h_{in,steam}-h_{out,steam})-T_0(s_{in,steam}-s_{out,steam})] \\
L_{past3}  = L_{past3,1} + L_{past3,2}
$$ 

#### Mixer

$$
L_{mixer,1}  = \dot{m}_{cr,o}c_{p,cr}[(T_{crpast,a} - T_{crpast,x})-T_0\ln(\frac{T_{crpast,a}}{T_{crpast,x}})] \\
L_{mixer,2} = \dot{m}_{th}c_{p,alginate}[(T_{th} - T_{crpast,x})-T_0\ln(\frac{T_{th}}{T_{crpast,x}})] \\
L_{mixer} = L_{mixer,1} + L_{mixer,2} 
$$


#### Summary of Pasteurization Exergy Results

```{r compute_pasteurisation_exergy, echo = F, eval = T}



```
### Evaporation 

#### Heat Exchanger

$$\dot{L}_{HX}=\dot{m}_{water}(h_{fg}-T_{a}s_{fg})-Q_{HX}(1-\frac{T_{a}}{T_{c,lm}})$$

#### Heat Evaporator

$$\dot{L}_{evaporator}=\dot{m}_{milk}(h_{milk,in}-h_{milk,out})-\dot{m}_{milk}T_{a}(s_{milk,in}-s_{milk,out})-\dot{m}_{water}Cp_{water}[T_{out}-$$

#### Splitter
There are no exergy losses in the spliiters since they are isenthalpic


#### Total

$$\dot{L}_{evaporation}=\Sigma\dot{L}_{HX}+\Sigma\dot{L}_{evaporator}+\Sigma\dot{L}_{splitter}$$


#### Results Exergy Analysis Evaporation

```{python HX, echo = T, eval = T}

#Heat exchangers

```


Furthermore, we highly encourage the use of a Sankey diagram to succinctly summarize your findings. We have provided an example of how to create an interactive Sankey diagram in R using the Plotly library. You can access the necessary function in the file `./sankey_ipese.R`. The following code chunk demonstrates how to utilize this function:

```{r sankey-function, echo = T, eval = T, warning = F, message=F}
source("./sankey_ipese.R") # introduce the sankey function from the source file
df = read.csv('atom_balance.csv',sep = '\t') # replace the atom_balance.csv with your exergy analysis results
sankey_ipese(df = df, unit = 'kmol/h', title = 'Example of an interactive Sankey diagram') # replace the unit and title here
```

## Energy bill

In this section, your objective is to transform the energy demand you previously calculated into utility consumption. This transformation involves the following energy vectors:

- Natural gas
- Electricity
- Water

To execute this conversion, you must explicitly state the assumptions you make during the process. For example, if you are aware of the refrigeration duty within the factory and understand that the refrigeration system operates on electricity, you will pre-determine the coefficient of performance (COP) for your refrigeration cycle. This assumption will enable you to calculate the actual electricity consumption for your processes.

You can refer to the "Brewery example" in the Suivival Guide for comprehensive guidance and relevant information to facilitate this conversion process.

Once you have established the energy utility demand within the dairy factory, you can proceed to calculate the energy bill. This calculation will be based on assumptions regarding energy prices in different countries or regions.

